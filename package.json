{
  "code": "abc123",
  "originalUrl": "https://google.com",
  "createdAt": "timestamp"
}
{
  "linkCode": "abc123",
  "ip": "192.168.1.1",
  "userAgent": "Chrome",
  "referrer": "https://facebook.com",
  "createdAt": "timestamp"
}
const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();

const db = admin.firestore();

exports.go = functions.https.onRequest(async (req, res) => {
  const code = req.path.split("/").pop();

  if (!code) {
    return res.status(400).send("Invalid link");
  }

  try {
    // Find link
    const linkQuery = await db
      .collection("links")
      .where("code", "==", code)
      .limit(1)
      .get();

    if (linkQuery.empty) {
      return res.status(404).send("Link not found");
    }

    const linkDoc = linkQuery.docs[0];
    const linkData = linkDoc.data();

    // Save click
    await db.collection("clicks").add({
      linkCode: code,
      ip: req.ip,
      userAgent: req.headers["user-agent"],
      referrer: req.headers.referer || null,
      createdAt: admin.firestore.FieldValue.serverTimestamp()
    });

    // Redirect
    res.redirect(linkData.originalUrl);

  } catch (error) {
    res.status(500).send("Server error");
  }
});
